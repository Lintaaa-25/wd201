<!DOCTYPE html>
<html>
<head>
  <title>Todo App</title>
</head>
<body>
  <form method="POST" action="/todos" onsubmit="return validateForm()">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="text" name="title" placeholder="Title">
    <input type="date" name="dueDate">
    <button type="submit">Add Todo</button>
  </form>

  <script>
    function validateForm() {
      const title = document.querySelector("[name='title']").value.trim();
      const dueDate = document.querySelector("[name='dueDate']").value.trim();
      if (!title || !dueDate) {
        alert("Title and Due Date required");
        return false;
      }
      return true;
    }

    function toggleStatus(id, checked) {
      fetch(`/todos/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ completed: checked })
      }).then(() => location.reload());
    }

    function deleteTodo(id) {
      fetch(`/todos/${id}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" }
      }).then(() => location.reload());
    }
  </script>

  <% function renderSection(title, id, todos) { %>
    <h3><%= title %> (<span id="count-<%= id %>"><%= todos.length %></span>)</h3>
    <ul>
      <% todos.forEach(todo => { %>
        <li class="Todo-Item">
          <label for="todo-<%= todo.id %>">
            <input type="checkbox" id="todo-<%= todo.id %>" <%= todo.completed ? "checked" : "" %>
              onchange="toggleStatus(<%= todo.id %>, this.checked)">
            <%= todo.title %> - <%= todo.dueDate %>
          </label>
          <button onclick="deleteTodo(<%= todo.id %>)">Delete</button>
        </li>
      <% }) %>
    </ul>
  <% } %>

  <% renderSection("Overdue", "overdue", overdue) %>
  <% renderSection("Due Today", "due-today", dueToday) %>
  <% renderSection("Due Later", "due-later", dueLater) %>
  <% renderSection("Completed Items", "completed", completed) %>
</body>
</html>
