<!DOCTYPE html>
<html>
  <head>
    <title>Todo Manager</title>
    <meta name="csrf-token" content="<%= csrfToken %>">
  </head>
  <body>
    <header>
      <h1>Todo Manager</h1>
    </header>

    <form action="/todos" method="POST">
      <input type="text" name="title" placeholder="Todo title" required />
      <input type="date" name="dueDate" required />
      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
      <button type="submit">Add</button>
    </form>

    <h2>Overdue (<span id="overdue-count"><%= overdue.length %></span>)</h2>
    <ul>
      <% overdue.forEach(todo => { %>
        <li>
          <input type="checkbox" onchange="toggleCompleted(<%= todo.id %>, <%= todo.completed %>)" />
          <%= todo.title %> (Due: <%= todo.dueDate %>)
          <button onclick="deleteTodo(<%= todo.id %>)">ðŸ—‘</button>
        </li>
      <% }) %>
    </ul>

    <h2>Due Today (<span id="due-today-count"><%= dueToday.length %></span>)</h2>
    <ul>
      <% dueToday.forEach(todo => { %>
        <li>
          <input type="checkbox" onchange="toggleCompleted(<%= todo.id %>, <%= todo.completed %>)" />
          <%= todo.title %>
          <button onclick="deleteTodo(<%= todo.id %>)">ðŸ—‘</button>
        </li>
      <% }) %>
    </ul>

    <h2>Due Later (<span id="due-later-count"><%= dueLater.length %></span>)</h2>
    <ul>
      <% dueLater.forEach(todo => { %>
        <li>
          <input type="checkbox" onchange="toggleCompleted(<%= todo.id %>, <%= todo.completed %>)" />
          <%= todo.title %> (Due: <%= todo.dueDate %>)
          <button onclick="deleteTodo(<%= todo.id %>)">ðŸ—‘</button>
        </li>
      <% }) %>
    </ul>

    <h2>Completed (<span id="completed-count"><%= completed.length %></span>)</h2>
    <ul>
      <% completed.forEach(todo => { %>
        <li>
          <input type="checkbox" checked onchange="toggleCompleted(<%= todo.id %>, <%= todo.completed %>)" />
          <s><%= todo.title %></s>
          <button onclick="deleteTodo(<%= todo.id %>)">ðŸ—‘</button>
        </li>
      <% }) %>
    </ul>

    <footer>Â© 2025 Your Name</footer>

    <script>
      function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute("content");
      }

      async function toggleCompleted(id, currentStatus) {
        const csrfToken = getCsrfToken();
        await fetch(`/todos/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken,
          },
        });
        window.location.reload();
      }

      async function deleteTodo(id) {
        const csrfToken = getCsrfToken();
        await fetch(`/todos/${id}`, {
          method: "DELETE",
          headers: {
            "X-CSRF-Token": csrfToken,
          },
        });
        window.location.reload();
      }
    </script>
  </body>
</html>
