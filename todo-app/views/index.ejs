<!DOCTYPE html>
<html>
<head>
  <title>Todo App</title>
  <meta name="csrf-token" content="<%= csrfToken %>">
</head>
<body>
  <h1>Todo App</h1>

  <form action="/todos" method="POST">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="text" name="title" placeholder="Title" required>
    <input type="date" name="dueDate" required>
    <button type="submit">Add Todo</button>
  </form>

  <h2>Overdue</h2>
  <ul>
    <% overdue.forEach(todo => { %>
      <li>
        <input type="checkbox" id="todo-<%= todo.id %>" <%= todo.completed ? "checked" : "" %> onclick="toggleCompleted(<%= todo.id %>)">
        <%= todo.title %> (Due: <%= todo.dueDate %>)
        <button onclick="deleteTodo(<%= todo.id %>)">Delete</button>
      </li>
    <% }) %>
  </ul>

  <h2>Due Today</h2>
  <ul>
    <% dueToday.forEach(todo => { %>
      <li>
        <input type="checkbox" id="todo-<%= todo.id %>" <%= todo.completed ? "checked" : "" %> onclick="toggleCompleted(<%= todo.id %>)">
        <%= todo.title %>
        <button onclick="deleteTodo(<%= todo.id %>)">Delete</button>
      </li>
    <% }) %>
  </ul>

  <h2>Due Later</h2>
  <ul>
    <% dueLater.forEach(todo => { %>
      <li>
        <input type="checkbox" id="todo-<%= todo.id %>" <%= todo.completed ? "checked" : "" %> onclick="toggleCompleted(<%= todo.id %>)">
        <%= todo.title %> (Due: <%= todo.dueDate %>)
        <button onclick="deleteTodo(<%= todo.id %>)">Delete</button>
      </li>
    <% }) %>
  </ul>

  <h2>Completed</h2>
  <ul>
    <% completed.forEach(todo => { %>
      <li>
        âœ… <%= todo.title %> (Due: <%= todo.dueDate %>)
        <button onclick="deleteTodo(<%= todo.id %>)">Delete</button>
      </li>
    <% }) %>
  </ul>

  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    async function deleteTodo(id) {
      await fetch(`/todos/${id}`, {
        method: "DELETE",
        headers: { "CSRF-Token": csrfToken },
        credentials: "same-origin"
      });
      window.location.reload();
    }

    async function toggleCompleted(id) {
      const checkbox = document.getElementById(`todo-${id}`);
      await fetch(`/todos/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "CSRF-Token": csrfToken
        },
        credentials: "same-origin",
        body: JSON.stringify({ completed: checkbox.checked })
      });
      window.location.reload();
    }
  </script>
</body>
</html>
