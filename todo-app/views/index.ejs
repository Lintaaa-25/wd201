<!DOCTYPE html>
<html>
<head>
  <title>Todo App</title>
</head>
<body>
  <h1>Todo Manager</h1>

  <form action="/todos" method="POST">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
    <input type="text" name="title" placeholder="Todo Title" required />
    <input type="date" name="dueDate" required />
    <button type="submit">Add Todo</button>
  </form>

  <h3>Incomplete</h3>
  <ul>
    <% incompleteTodos.forEach(todo => { %>
      <li>
        <input
          type="checkbox"
          class="todo-checkbox"
          data-id="<%= todo.id %>"
          data-csrf="<%= csrfToken %>"
          <%= todo.completed ? "checked" : "" %>
        />
        <%= todo.title %> - <%= todo.dueDate %>
        <form action="/todos/<%= todo.id %>?_method=DELETE" method="POST" style="display:inline;">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button type="submit">Delete</button>
        </form>
      </li>
    <% }) %>
  </ul>

  <h3>Completed</h3>
  <ul>
    <% completedTodos.forEach(todo => { %>
      <li>
        <input
          type="checkbox"
          class="todo-checkbox"
          data-id="<%= todo.id %>"
          data-csrf="<%= csrfToken %>"
          <%= todo.completed ? "checked" : "" %>
        />
        <%= todo.title %> - <%= todo.dueDate %>
        <form action="/todos/<%= todo.id %>?_method=DELETE" method="POST" style="display:inline;">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button type="submit">Delete</button>
        </form>
      </li>
    <% }) %>
  </ul>

  <script>
    document.querySelectorAll(".todo-checkbox").forEach((checkbox) => {
      checkbox.addEventListener("change", async (e) => {
        const todoId = e.target.dataset.id;
        const completed = e.target.checked;
        const csrfToken = e.target.dataset.csrf;

        const response = await fetch(`/todos/${todoId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken,
          },
          body: JSON.stringify({ completed }),
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert("Update failed");
        }
      });
    });
  </script>
</body>
</html>
